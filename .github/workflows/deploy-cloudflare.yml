name: ğŸš€ Deploy ASOOS 2100.Cool to Cloudflare Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ” Quality Assurance
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate HTML
        run: |
          echo "ğŸ” Validating HTML structure..."
          # Check for required meta tags
          grep -q 'charset="UTF-8"' index.html || (echo "âŒ Missing charset meta tag" && exit 1)
          grep -q 'viewport' index.html || (echo "âŒ Missing viewport meta tag" && exit 1)
          
          # Check for authentication functions
          grep -q 'initiateAuthentication' index.html || (echo "âŒ Authentication function missing" && exit 1)
          
          # Verify authentication redirects to /auth
          if grep -q "window.location.href = '/auth'" index.html; then
            echo "âœ… Authentication redirects properly configured"
          else
            echo "âŒ Authentication should redirect to /auth" && exit 1
          fi
          
          echo "âœ… HTML validation passed"

      - name: Security Check
        run: |
          echo "ğŸ”’ Security validation..."
          
          # Check for inline scripts (should be minimal for security)
          INLINE_SCRIPTS=$(grep -c '<script>' index.html || true)
          echo "ğŸ“Š Inline scripts found: $INLINE_SCRIPTS"
          
          # Check file size
          INDEX_SIZE=$(stat -c%s index.html)
          echo "ğŸ“Š File size: ${INDEX_SIZE} bytes"
          
          echo "âœ… Security check completed"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    name: ğŸŒ Deploy to Cloudflare Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare deployment
        run: |
          echo "ğŸ“¦ Preparing deployment package..."
          
          # Create deployment directory
          mkdir -p ./dist
          
          # Copy main files
          cp index.html ./dist/
          cp README.md ./dist/ || echo "README.md not found, skipping"
          
          # Create _redirects file for Cloudflare Pages
          cat > ./dist/_redirects << EOF
          # Authentication routing
          /auth https://auth.2100.cool/auth 200
          /interface https://auth.2100.cool/interface 200
          
          # Fallback to main page
          /* /index.html 200
          EOF
          
          # Create robots.txt
          cat > ./dist/robots.txt << EOF
          User-agent: *
          Allow: /
          
          Sitemap: https://2100.cool/sitemap.xml
          EOF
          
          # Create sitemap.xml
          cat > ./dist/sitemap.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://2100.cool/</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
          </urlset>
          EOF
          
          # Create security headers via _headers file
          cat > ./dist/_headers << EOF
          /*
            X-Frame-Options: DENY
            X-Content-Type-Options: nosniff
            X-XSS-Protection: 1; mode=block
            Referrer-Policy: strict-origin-when-cross-origin
            Permissions-Policy: geolocation=(), microphone=(), camera=()
            Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://www.google-analytics.com;
          EOF
          
          echo "âœ… Deployment package prepared"

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Cloudflare credentials from GCP Secret Manager
        run: |
          echo "ğŸ” Retrieving Cloudflare credentials from GCP Secret Manager..."
          
          # Get Cloudflare API token from GCP secrets
          CLOUDFLARE_TOKEN=$(gcloud secrets versions access latest --secret="cloudflare-api-token" 2>/dev/null || echo "")
          CLOUDFLARE_ACCOUNT=$(gcloud secrets versions access latest --secret="cloudflare-account-id" 2>/dev/null || echo "")
          
          if [ -n "$CLOUDFLARE_TOKEN" ] && [ -n "$CLOUDFLARE_ACCOUNT" ]; then
            echo "âœ… Cloudflare credentials retrieved from GCP"
            echo "CLOUDFLARE_API_TOKEN=${CLOUDFLARE_TOKEN}" >> $GITHUB_ENV
            echo "CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT}" >> $GITHUB_ENV
          else
            echo "âš ï¸ Cloudflare credentials not found in GCP Secret Manager"
            echo "Will attempt direct deployment without API tokens"
          fi

      - name: Deploy to Cloudflare Pages (with GCP OAuth2)
        run: |
          echo "ğŸš€ Deploying to Cloudflare Pages via GCP OAuth2..."
          
          # Install Cloudflare Wrangler CLI
          npm install -g wrangler@latest
          
          # Try to deploy using OAuth2 flow
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo "ğŸ“¡ Using API token from GCP Secret Manager"
            export CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN"
            export CLOUDFLARE_ACCOUNT_ID="$CLOUDFLARE_ACCOUNT_ID"
            
            # Deploy using wrangler
            wrangler pages deploy dist \
              --project-name=asoos-2100-cool \
              --compatibility-date=2024-01-01 || echo "âš ï¸ Wrangler deployment failed, trying alternative method"
          else
            echo "âš ï¸ No API tokens available, deployment requires manual Cloudflare Pages setup"
            echo "ğŸ“‹ Files prepared in ./dist/ directory"
            echo "ğŸ”— Connect your GitHub repo to Cloudflare Pages dashboard: https://dash.cloudflare.com/pages"
          fi

  verify:
    runs-on: ubuntu-latest
    needs: deploy
    name: ğŸ” Verify Deployment
    steps:
      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to be available..."
          sleep 60

      - name: Test site accessibility
        run: |
          echo "ğŸ” Testing site accessibility..."
          
          # Check if main site is accessible
          if curl -f -s -o /dev/null https://2100.cool/; then
            echo "âœ… Main site accessible"
          else
            echo "âš ï¸ Main site not accessible yet"
          fi
          
          # Check if authentication redirects work
          echo "ğŸ” Testing authentication flow..."
          if curl -s -o /dev/null -w "%{http_code}" https://2100.cool/auth | grep -q "200\|302\|301"; then
            echo "âœ… Auth endpoint responsive"
          else
            echo "âš ï¸ Auth endpoint may need configuration"
          fi

      - name: Test authentication buttons
        run: |
          echo "ğŸ”˜ Verifying authentication button functionality..."
          
          # Download the page and check for correct authentication function
          curl -s https://2100.cool/ | grep -q "window.location.href = '/auth'" && echo "âœ… Authentication buttons configured correctly" || echo "âŒ Authentication buttons need fixing"

  notify:
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    name: ğŸ“¢ Deployment Notification
    if: always()
    steps:
      - name: Success Notification
        if: ${{ needs.deploy.result == 'success' }}
        run: |
          echo "ğŸ‰ ASOOS 2100.Cool successfully deployed to Cloudflare Pages!"
          echo "ğŸŒ Live URL: https://2100.cool"
          echo "ğŸ” Authentication: Sally Port Integration Active"
          echo "ğŸ­ Sacred Mission: Operational"
          echo "âš¡ Cloudflare: Global CDN Active"

      - name: Failure Notification  
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          echo "âŒ Deployment failed. Please check the logs."
          echo "ğŸ” Check Cloudflare configuration and API tokens"

# Environment Variables Required:
# - GCP_SA_KEY: GCP Service Account JSON key for OAuth2 authentication
# 
# GCP Secrets Expected (automatically retrieved):
# - cloudflare-api-token: Cloudflare API token stored in GCP Secret Manager
# - cloudflare-account-id: Cloudflare account ID stored in GCP Secret Manager
#
# This workflow uses GCP OAuth2 to retrieve Cloudflare credentials,
# creating a cloud-to-cloud authentication flow without manual token management
