name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js 24.x
      uses: actions/setup-node@v4
      with:
        node-version: 24.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build --if-present
    
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
    
    - name: Deploy to Google Cloud
      run: |
        gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
        gcloud config set compute/zone us-west1-b
        gcloud config set compute/region us-west1
        
        # Deploy containers to Cloud Run
        for dir in containers/*/; do
          if [ -f "${dir}Dockerfile" ]; then
            service_name=$(basename "$dir")
            echo "Deploying $service_name to Cloud Run..."
            
            # Build and push the image
            gcloud builds submit "$dir" --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/$service_name
            
            # Deploy to Cloud Run
            gcloud run deploy $service_name \
              --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/$service_name \
              --platform managed \
              --region us-west1 \
              --allow-unauthenticated
          fi
        done
